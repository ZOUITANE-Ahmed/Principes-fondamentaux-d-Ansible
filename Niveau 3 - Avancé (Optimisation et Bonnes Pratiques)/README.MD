# **ğŸ“Œ Niveau 3 : AvancÃ© (Optimisation et Bonnes Pratiques Ansible)**  

Dans ce niveau, nous allons explorer **les stratÃ©gies dâ€™optimisation**, **les bonnes pratiques** et la gestion **dâ€™environnements complexes** avec Ansible.  

---

## **1ï¸âƒ£ Optimisation des Performances Ansible**  

Lorsque lâ€™environnement sâ€™agrandit, Ansible peut devenir **plus lent**. Voici des techniques pour lâ€™optimiser.

### **A. ExÃ©cution ParallÃ¨le avec Forks**  
ğŸ“Œ **Augmenter le nombre dâ€™hÃ´tes traitÃ©s simultanÃ©ment**  

Dans `ansible.cfg`, augmente la valeur de `forks` :  
```ini
[defaults]
forks = 50
```
âœ… **Plus de tÃ¢ches exÃ©cutÃ©es en parallÃ¨le**, surtout utile dans de grands environnements.  

---

### **B. AccÃ©lÃ©rer SSH avec Pipelining**  
ğŸ“Œ **Ã‰viter lâ€™ouverture rÃ©pÃ©tÃ©e de connexions SSH**  

Dans `ansible.cfg`, active `pipelining` :  
```ini
[ssh_connection]
pipelining = True
```
âœ… **Moins de latence entre les commandes**.  

---

### **C. Utiliser Fact Caching**  
ğŸ“Œ **Ã‰viter de rÃ©cupÃ©rer les faits (`facts`) Ã  chaque exÃ©cution**  

Active le cache des facts pour accÃ©lÃ©rer lâ€™exÃ©cution des playbooks :  
```ini
[defaults]
fact_caching = jsonfile
fact_caching_connection = /tmp/ansible_facts
```
âœ… **RÃ©duit le temps dâ€™exÃ©cution en Ã©vitant des requÃªtes inutiles**.  

---

### **D. Limiter le Nombre de TÃ¢ches ExÃ©cutÃ©es**  
ğŸ“Œ **Utiliser `--limit` et `--tags` pour exÃ©cuter uniquement ce qui est nÃ©cessaire**  

```bash
ansible-playbook site.yml --limit webservers
ansible-playbook site.yml --tags "install"
```
âœ… **ExÃ©cute uniquement les tÃ¢ches ciblÃ©es**, Ã©vitant des exÃ©cutions inutiles.  

---

## **2ï¸âƒ£ Bonnes Pratiques de Structuration**  

Un projet Ansible bien structurÃ© facilite **la maintenance et la rÃ©utilisation**.  

### **A. Organisation dâ€™un Projet Modulaire avec les RÃ´les**  
ğŸ“Œ **Structure recommandÃ©e**  
```
ansible_project/
â”œâ”€â”€ inventories/
â”‚   â”œâ”€â”€ production
â”‚   â”œâ”€â”€ staging
â”‚   â””â”€â”€ development
â”œâ”€â”€ group_vars/
â”œâ”€â”€ host_vars/
â”œâ”€â”€ roles/
â”‚   â”œâ”€â”€ webserver/
â”‚   â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ application/
â”‚   â””â”€â”€ security/
â”œâ”€â”€ playbooks/
â”‚   â”œâ”€â”€ site.yml
â”‚   â”œâ”€â”€ webservers.yml
â”‚   â”œâ”€â”€ databases.yml
â”‚   â””â”€â”€ security.yml
â””â”€â”€ ansible.cfg
```
âœ… **SÃ©paration claire des responsabilitÃ©s** et **rÃ©utilisation des rÃ´les**.  

---

### **B. Utiliser des Variables StructurÃ©es et SÃ©curisÃ©es**  
ğŸ“Œ **Centraliser les variables dans `group_vars/` et `host_vars/`**  

Exemple `group_vars/webservers.yml` :  
```yaml
nginx_version: "1.20"
web_root: "/var/www/html"
```
âœ… **Ã‰vite la duplication des variables dans les playbooks**.  

---

### **C. SÃ©curiser les DonnÃ©es Sensibles avec Ansible Vault**  
ğŸ“Œ **Chiffrer les fichiers contenant des mots de passe**  
```bash
ansible-vault encrypt group_vars/database.yml
```
Pour **Ã©diter** un fichier chiffrÃ© :  
```bash
ansible-vault edit group_vars/database.yml
```
âœ… **ProtÃ¨ge les informations sensibles** (mots de passe, clÃ©s APIâ€¦).  

---

## **3ï¸âƒ£ Gestion des Logs et DÃ©bogage AvancÃ©**  

ğŸ“Œ **ExÃ©cuter un playbook avec un mode dÃ©taillÃ© (`-vvvv`)**  
```bash
ansible-playbook playbook.yml -vvvv
```
ğŸ“Œ **Stocker les logs dans un fichier (`ansible.cfg`)**  
```ini
[defaults]
log_path = /var/log/ansible.log
```
âœ… **Facilite lâ€™audit et le dÃ©bogage des exÃ©cutions.**  

---

## **4ï¸âƒ£ Gestion des Environnements Complexes**  

### **A. DÃ©ploiement Multi-Tiers (Web, App, DB)**  
ğŸ“Œ **Exemple dâ€™inventaire pour un environnement avec plusieurs couches**  
```yaml
all:
  children:
    webservers:
      hosts:
        web01:
          ansible_host: 192.168.1.10
        web02:
          ansible_host: 192.168.1.11
    appservers:
      hosts:
        app01:
          ansible_host: 192.168.1.20
    dbservers:
      hosts:
        db01:
          ansible_host: 192.168.1.30
```
âœ… **Permet de sÃ©parer les rÃ´les et dâ€™appliquer des configurations spÃ©cifiques**.  

---

### **B. Load Balancing avec HAProxy**  
ğŸ“Œ **Exemple de configuration HAProxy pour rÃ©partir la charge entre `web01` et `web02`**  
```yaml
- name: Installer HAProxy
  hosts: lbservers
  become: true
  tasks:
    - name: Installer HAProxy
      apt:
        name: haproxy
        state: present

    - name: Configurer HAProxy
      template:
        src: haproxy.cfg.j2
        dest: /etc/haproxy/haproxy.cfg
      notify: RedÃ©marrer HAProxy

  handlers:
    - name: RedÃ©marrer HAProxy
      service:
        name: haproxy
        state: restarted
```
ğŸ“Œ **Fichier `templates/haproxy.cfg.j2`**  
```ini
frontend http_front
    bind *:80
    default_backend webservers

backend webservers
    balance roundrobin
    server web01 192.168.1.10:80 check
    server web02 192.168.1.11:80 check
```
âœ… **HAProxy distribue le trafic HTTP entre plusieurs serveurs**.  

---

## **5ï¸âƒ£ Automatisation AvancÃ©e avec AWX / Ansible Tower**  
AWX (version open-source de **Ansible Tower**) permet de gÃ©rer les playbooks via une interface web.  

### **A. Avantages dâ€™AWX**  
âœ… Interface graphique pour gÃ©rer les playbooks  
âœ… ExÃ©cutions planifiÃ©es  
âœ… Logs centralisÃ©s et gestion des erreurs  
âœ… ContrÃ´le des accÃ¨s et permissions  

### **B. Installation dâ€™AWX**  
ğŸ“Œ **Installer AWX avec Docker**  
```bash
git clone https://github.com/ansible/awx.git
cd awx/installer
ansible-playbook -i inventory install.yml
```
âœ… Une fois installÃ©, accÃ©der Ã  **http://localhost:80** et commencer Ã  exÃ©cuter des playbooks.  

---

## **ğŸ¯ Objectifs pour passer au Niveau 4 (Expert)**  
ğŸ”¹ MaÃ®triser **Ansible Tower/AWX**  
ğŸ”¹ Automatiser **les infrastructures cloud (AWS, Azure, GCP)**  
ğŸ”¹ SÃ©curiser **les dÃ©ploiements (RBAC, Vault avancÃ©, secrets management)**  
ğŸ”¹ Optimiser **les performances avec des stratÃ©gies avancÃ©es**  
ğŸ”¹ IntÃ©grer **Ansible avec Terraform pour lâ€™Infrastructure as Code**  
